<h1>Математическая модель фокона</h1>

Внешний вид окна программы представлен на рисунке 1. 

![image](https://user-images.githubusercontent.com/45719826/169312203-fc5861d7-c46f-4f66-b372-3e7684e97015.png)
Рисунок 1 – Рабочее окно программы

Основную часть рабочего пространства занимает сечение фокона в плоскости YOZ, в правой верхней части расположена его уменьшенная проекция в плоскости XOY. Очевидно, что фокон размещён в системе координат таким образом, что его ось вращения совпадает с осью Z, а входная апертура лежит в плоскости XOY.

В левой части окна располагается панель управления, содержащая полный набор входных параметров самого фокона, входного луча, используемого приёмника и линз.

<h2>Основные используемые понятия</h2>

<h3>Фокон</h3>
В строгом смысле фокон представляет собой ограниченный участок конической поверхности, обычно ориентированный по ходу оптической оси сужающимся концом. Тем не менее, при вводе параметров фокона не задаётся ограничений на взаимное соотношение диаметров входной и выходной апертуры, поэтому в рамках используемой модели возможно также задать перевёрнутый фокон, расширяющийся к выходу, а также цилиндрическую трубку постоянного диаметра. Все вычисления в фоконах нестандартного типа работают исправно.
  
<h3>Луч</h3>

Луч в рамках настоящей модели представляет собой прямую, заданную точкой в пространстве и направляющим вектором. Входной луч задаётся координатами пересечения с входной апертурой фокона и углом относительно оси Z. Таким образом, любой входной луч принадлежит плоскости, параллельной плоскости YOZ, и угол между лучом и осью X изначально всегда равен 90°. Данное решение обосновано осевой симметрией системы: для любого произвольно направленного луча можно путём преобразования координат найти эквивалентный луч, удовлетворяющий заданным ограничениям, поэтому результаты вычислений будут одинаковы. Достоинством выбранного подхода является возможность упростить и оптимизировать ряд алгоритмов.
  
<h3>Приёмник</h3>

Параметры приёмника позволяют задать конструктивные параметры реального фотодиода, имеющего входное окно и расположенного в некотором углублении относительно него. Существует также возможность задать фотодиод заданного диаметра без корпуса: для этого необходимо установить нулевое смещение относительно оси Z, а диаметр входного окна задать не меньше выходной апертуры фокона.
В меню «Элементы» доступны для выбора в качестве приёмника предустановленные фотодиоды Hamamatsu: G12180-005A, G12180-010A, G12180-020A. Конструктивные параметры указанных моделей соответствуют указанным в официальной документации.

<h3>Собирающая линза</h3>

В настоящей модели введена возможность включить в схему собирающую линзу, расположенную во входной апертуре фокона. В рамках настоящей модели используется идеальная тонкая линза, её реальные конструктивные параметры не задаются.

Фокусное расстояние линзы можно задать вручную или назначить автоматически. Автоматически вычисляемое значение фокусного расстояния основано на расстоянии от входной апертуры фокона до чувствительной поверхности приёмника и реализовано в трёх вариантах: идеальный автофокус и с положительной или отрицательной дефокусировкой, определяемой также конструкцией приёмника. Автоматические значения фокусного расстояния при дефокусировке линзы заданы таким образом, что параллельный соосный пучок формирует в плоскости изображения распределённое пятно рассеяния, а не единственную точку. 

<h3>Окуляр</h3>
Под окуляром в рамках настоящей модели понимается тонкая линза, расположенная в выходной апертуре фокона. Строго говоря, такое название является не вполне правильным, поскольку область применения фокона не подразумевает ни формирования действительного изображения, ни наблюдения с помощью глаз. Тем не менее, с учётом реализованного объектива (см. выше), по аналогии со схемой телескопической системы и в целях краткости принято решение обозначить данный оптический элемент как окуляр.

В качестве окуляра возможно использовать как положительную, так и отрицательную линзу. Величина модуля фокусного расстояния окуляра ограничена снизу радиусом выходной апертуры и сверху значением 100 мм.

<h3>Стеклянный фокон</h3>
В рамках настоящей модели была реализована возможность исполнения фокона из стекла как с плоским выходным торцом, так и с полостью конической формы на выходе. При моделировании стеклянного фокона принят ряд допущений:

1.	Коническая поверхность фокона покрыта отражающим покрытием и не пропускает лучи наружу.
2.	Плоский выходной торец фокона пропускает лучи согласно закону преломления.
3.	Коническая воздушная полость пропускает лучи, входящие в неё из стеклянного объёма фокона согласно закону преломления, но не пропускает лучей из воздуха в стекло, полностью отражая их.

<h2>Обзор реализованных режимов</h2>
<h3>Расчётные режимы</h3>
<h4>Расчёт одного луча</h4>
Основополагающий режим, полностью рассчитывающий ход луча в фоконе по заданным входным параметрам и проецирующий его на плоскости XOY и YOZ. Результатом вычислений в данном режиме является одно из четырёх состояний, которыми может закончиться прохождение лучом фокона и которые обозначаются разными цветами:
  
1.	<b>Красный</b>: лучу не удалось пройти через фокон, после переотражений он вышел обратно через входную апертуру.
2.	<b>Оранжевый</b>: луч прошёл через фокон, но не попал на чувствительную поверхность приёмника.
3.	<b>Жёлтый</b>: луч попал на чувствительную поверхность приёмника вне его углового поля, поэтому не был обнаружен.
4.	<b>Зелёный</b>: луч был обнаружен.
  
Перечисленные состояния используются для оценки потерь пучков в других режимах, при этом потерями считаются красные, оранжевые и жёлтые лучи. Ослабление сигнала при переотражениях на данный момент не учитывается, то есть коэффициент отражения ρ принят равным 1. Тем не менее, по результатам вычисления в данном режиме в статусной строке выводится сообщение о количестве отражений, которые претерпел входной луч, поэтому существует возможность усложнения модели для оценки ослабления интенсивности единичного луча.
  
<h4>Параллельный пучок</h4>
Данный режим позволяет рассчитать ход лучей, попадающих во входную апертуру фокона под одним углом во множестве дискретных точек, и оценить потери для такого пучка. Массив входных точек проецируется на плоскость XOY и кодируется цветами, обозначающими результат прохождения соответствующего луча. В статусной строке выводится сообщение об общем и принятом количестве лучей, а также результат оценки потерь в дБ.

<h4>Выход параллельного пучка</h4>
Данный режим предназначен для оценки расположения лучей параллельного пучка в пространстве после прохождения фокона. Входные данные задаются так же, как в предыдущем режиме, но для представления результатов на плоскость XOY проецируется не входная, а выходная апертура фокона. Каждая из спроецированных на плоскость XOY точек обозначает точку пересечения выходящего луча с выходной апертурой фокона без учёта конструкции приёмника и факта обнаружения луча. Лучи, после переотражений не дошедшие до выходной апертуры фокона, в данном режиме не отображаются и не учитываются.
Цвет точки кодирует угол между лучом и осью Z. Фиолетовый цвет обозначает угол 0°, красный – 90°, а прочие цвета спектра соответствуют промежуточным значениям. Для упрощения визуального восприятия в таблице 1 представлены цвета, соответствующие некоторым опорным значениям углов. По результатам вычислений в статусной строке выводится сообщение о среднем значении выходного угла.

Таблица 1 – Соответствие цветового кода величине угла
![image](https://user-images.githubusercontent.com/45719826/169313581-94a55a6f-2c32-4050-b021-0f688cd05e30.png)

<h4>Расходящийся пучок</h4>
Данный режим позволяет рассчитать ход лучей, пересекающих входную апертуру фокона в одной точке под множеством дискретных углов, абсолютная величина которых ограничена сверху модулем заданного значения входного угла. Массив входных лучей проецируется на плоскость YOZ и также кодируется цветами в соответствии с результатами прохождения. В статусной строке выводится сообщение об общем и принятом количестве лучей, а также результат оценки потерь в дБ.
  
<h4>Полный перебор</h4>
Комплексный режим, сочетающий в себе два предыдущих. Методика полного перебора заключается в задании множества дискретных точек в плоскости входной апертуры фокона и расчёта расходящихся пучков из каждой такой точки. В статусной строке выводится сообщение об общем и принятом количестве лучей, а также результат оценки потерь в дБ.
  
<h4>Метод Монте-Карло</h4>
Метод Монте-Карло в принятой модели основан на проведении расчёта хода большого множества лучей со случайными входными параметрами. При этом входная точка должна находиться в пределах входной апертуры фокона, а модуль входного угла не может превышать модуль величины, заданной пользователем. В статусной строке выводится сообщение об общем и принятом количестве лучей, а также результат оценки потерь в дБ.

<h3>Оптимизационные режимы</h3>
<h4>Оптимизация длины</h4>
Длина – единственный конструктивный параметр фокона, не заданный строго условиями ТЗ и не связанный с габаритами приёмника. При этом очевидно, что регулировка длины способна оказывать существенное влияние на ход лучей ввиду своей прямой взаимосвязи с углом при вершине фокона.

Данный режим предназначен для поиска наиболее оптимального целого значения длины фокона путём итерационного перебора соответствующих значений и оценки потерь для каждого из них методом полного перебора. При этом потери параллельного пучка для заданного входного угла не должны превышать 10 дБ. Данный критерий задан в связи с тем, что при увеличении длины фокона возможно уменьшение общих потерь только за счёт параксиальных лучей при полном пропуске угловых пучков.

<h4>Оптимизация выхода</h4>
Под оптимизацией выхода здесь понимается оптимизация диаметра выходного окна фокона.  Необходимость внедрения такого режима выявлена опытным путём: изначально диаметр выходного окна при моделировании вручную задавался не менее диаметра входного окна фотодиода, но иногда обнаруживалось, что при некотором уменьшении или увеличении этого значения общие потери уменьшаются. 

Из конструктивных соображений при оптимизации рассматриваются только значения, кратные 0,5 мм. Критерий оптимизации: минимальные потери при полном переборе, при этом потери параллельных пучков для заданного и нулевого входных углов не должны превышать 10 дБ. В статусной строке выводится сообщение найденном оптимальном значении, а также результат оценки потерь в дБ. 

<h4>Оптимизация линзы</h4>
Под оптимизацией линзы здесь понимается оптимизация фокусного расстояния линзы в целочисленных значениях. Минимальное рассматриваемое при оптимизации значение f'min определяется из условия:

![image](https://user-images.githubusercontent.com/45719826/169315968-540691cf-84cf-4fb5-894d-b4b81ddbe45a.png),

где k – диафрагменное число линзы,
D – диаметр линзы, определяемый в данном случае диаметром входной апертуры фокона.

Максимальное рассматриваемое значение f'max задаётся таким образом, чтобы луч при заданном значении входного угла при попадании на край апертуры после преломления шёл параллельно оптической оси. Оно определяется соотношением:

![image](https://user-images.githubusercontent.com/45719826/169316034-4e146483-fe49-4eb8-ab01-0683f5c895ee.png),

где α – диафрагменное число линзы.

Очевидно, что возможно и дальнейшее увеличение фокусного расстояния, но с точки зрения уменьшения потерь при прохождении фокона оно не представляется целесообразным. Можно заметить, что рассматриваемый диапазон фокусных расстояний обратно пропорционален величине входного угла, поэтому с целью уменьшения количества необходимых вычислений на малых углах f'max ограничен на уровне 500 мм.

<h4>Полная оптимизация</h4>
Режим полной оптимизации предназначен для нахождения оптимальной конструкции фокона и объединяет в себе комбинацию режимов оптимизации длины и оптимизации выхода. Принципы вычисления и используемые критерии аналогичны рассмотренным выше в соответствующих подразделах.

<h2>Дополнительные возможности</h2>
<h3>Меню «Файл»</h3>
С помощью меню «Файл» реализована возможность сохранять и загружать используемые входные параметры, что избавляет от необходимости конфигурирования известной системы с нуля при запуске программы. 

<h3>Меню «Изображение»</h3>
С помощью меню «Изображение» реализована возможность сохранять графические результаты моделирования хода лучей либо полностью, либо выборочно в проекции на плоскость XOY.

<h3>Меню «Элементы»</h3>
В меню «Элементы» доступны для выбора в качестве приёмника предустановленные фотодиоды Hamamatsu: G12180-005A, G12180-010A, G12180-020A.

<h3>Меню «Вид»</h3>
С помощью меню «Вид» реализована возможность переключения между светлой и тёмной темами. Первая более подходит для представления результатов в отчётах, тогда как вторая может быть удобнее для пользователя, особенно в условиях долгой работы с программой.

<h3>Поворот вида</h3>
Для вычислительных режимов, поддерживающих графическое отображение результатов (а именно «Расчёт одного луча», «Параллельный пучок», «Расходящийся пучок»), реализована возможность вращения полученных проекций на 360° вокруг оси Z. Данная функция предназначена для улучшения наглядности и упрощения визуального контроля результатов расчёта.

<h3>Точность</h3>
Для всех режимов, кроме «Расчёта одного луча», реализована возможность выбора средней или повышенной степени точности. Данная настройка влияет на скорость вычислений и предназначена в первую очередь для применения в оптимизационных режимах, поскольку именно они по своей природе являются самыми асимптотически сложными. Тем не менее, как правило, при рассматриваемых значениях входных углов (5° и меньше), используемая реализация как расчётных, так и оптимизационных алгоритмов обеспечивает достаточно быстрое получение результатов вычислений (мгновенно или не более нескольких секунд), поэтому в общем случае рекомендуется использовать повышенную точность, установленную по умолчанию.
